<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>極禾鍋物職人 - 北市延平店 線上訂位</title>
    
    <!-- 1. 載入 Tailwind CSS 核心 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 設定 Tailwind 主題顏色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            blue: '#0F2849',
                            gold: '#C5A059',
                            light: '#F0F4F8'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- 3. 載入 React 相關套件 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. 載入 Lucide 圖示庫 -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #0F2849;
            color: #333;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .glass-panel { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div id="root" class="flex h-screen w-full items-center justify-center text-white">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand-gold mx-auto mb-4"></div>
            <p>系統載入中...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 設定與常數 ---
        const STORE_NAME = "極禾鍋物職人-北市延平店";
        const PHONE_NUMBER = "02-28166658";
        const ADMIN_PASSWORD = "8888";
        const TOTAL_DURATION = 100; 
        
        // 桌位定義：A區與B區
        const TABLES = [
            // A區
            { id: 'A1', name: 'A1', parts: ['A1_In', 'A1_Out'] },
            { id: 'A2', name: 'A2', parts: ['A2_In', 'A2_Out'] },
            { id: 'A3', name: 'A3', parts: ['A3_In', 'A3_Out'] },
            { id: 'A5', name: 'A5', parts: ['A5_In', 'A5_Out'] },
            { id: 'A6', name: 'A6', parts: ['A6_In', 'A6_Out'] },
            { id: 'A7', name: 'A7', parts: ['A7_In', 'A7_Out'] },
            { id: 'A8', name: 'A8', parts: ['A8_In', 'A8_Out'] },
            { id: 'A9', name: 'A9', parts: ['A9_In', 'A9_Out'] },
            // B區
            { id: 'B1', name: 'B1', parts: ['B1_In', 'B1_Out'] },
            { id: 'B2', name: 'B2', parts: ['B2_In', 'B2_Out'] },
            { id: 'B3', name: 'B3', parts: ['B3_In', 'B3_Out'] },
            { id: 'B5', name: 'B5', parts: ['B5_In', 'B5_Out'] },
            { id: 'B6', name: 'B6', parts: ['B6_In', 'B6_Out'] },
            { id: 'B7', name: 'B7', parts: ['B7_In', 'B7_Out'] },
        ];

        // --- 工具元件：Icon ---
        const Icon = ({ name, size = 16, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', kebabName);
                    iconRef.current.innerHTML = '';
                    iconRef.current.appendChild(i);
                    window.lucide.createIcons({
                        root: iconRef.current,
                        nameAttr: 'data-lucide',
                        attrs: { width: size, height: size }
                    });
                }
            }, [name, size]);
            return <span ref={iconRef} className={`inline-flex items-center justify-center ${className}`} style={{ width: size, height: size }} />;
        };

        // --- 工具元件：Modal ---
        const Modal = ({ isOpen, title, content, onConfirm, onCancel, confirmText = "確認", cancelText = "取消", type = "danger", customContent = null }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in p-4">
                    <div className="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
                        <h3 className="text-lg font-bold text-gray-900 mb-2">{title}</h3>
                        {customContent ? customContent : <p className="text-gray-500 mb-6 text-sm leading-relaxed">{content}</p>}
                        
                        {!customContent && (
                            <div className="flex gap-3 mt-4">
                                {onCancel && (
                                    <button onClick={onCancel} className="flex-1 py-2.5 rounded-lg border border-gray-300 text-gray-700 font-bold hover:bg-gray-50 transition">{cancelText}</button>
                                )}
                                <button onClick={onConfirm} className={`flex-1 py-2.5 rounded-lg text-white font-bold shadow-md transition ${type === 'danger' ? 'bg-red-500 hover:bg-red-600' : 'bg-brand-blue hover:bg-blue-900'}`}>{confirmText}</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 工具函式 ---
        const getDates = (includePast = false) => {
            const dates = [];
            const today = new Date();
            // 如果是後台(includePast=true)，顯示今天及未來7天。如果是前台，顯示明天起7天
            const startDay = includePast ? 0 : 1; 
            
            for (let i = startDay; i <= 7; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                dates.push({
                    value: d.toISOString().split('T')[0],
                    display: `${d.getMonth() + 1}/${d.getDate()} (${['日','一','二','三','四','五','六'][d.getDay()]})`
                });
            }
            return dates;
        };

        const timeToMinutes = (timeStr) => {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        };

        const minutesToTime = (mins) => {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        };

        const generateTimeSlots = (type) => {
            const slots = [];
            if (type === 'lunch') {
                for (let m = timeToMinutes("11:30"); m <= timeToMinutes("14:00"); m += 15) slots.push(minutesToTime(m));
            } else {
                for (let m = timeToMinutes("17:00"); m <= timeToMinutes("21:00"); m += 15) slots.push(minutesToTime(m));
            }
            return slots;
        };

        const findAvailableTable = (date, timeStr, pax, existingBookings) => {
            if (!date || !timeStr) return null;
            const reqStart = timeToMinutes(timeStr);
            const reqEnd = reqStart + TOTAL_DURATION;

            const conflictBookings = existingBookings.filter(b => {
                if (b.date !== date || b.status === 'cancelled') return false;
                const bStart = timeToMinutes(b.time);
                const bEnd = bStart + TOTAL_DURATION;
                return reqStart < bEnd && reqEnd > bStart;
            });

            const occupiedParts = new Set();
            conflictBookings.forEach(b => {
                if (Array.isArray(b.assignedParts)) {
                    b.assignedParts.forEach(p => occupiedParts.add(p));
                }
            });

            if (pax <= 2) {
                for (let table of TABLES) {
                    const partAOccupied = occupiedParts.has(table.parts[0]);
                    const partBOccupied = occupiedParts.has(table.parts[1]);
                    if (!partAOccupied) return { tableId: table.name, parts: [table.parts[0]], type: 'split' };
                    if (!partBOccupied) return { tableId: table.name, parts: [table.parts[1]], type: 'split' };
                }
            } else {
                for (let table of TABLES) {
                    const partAOccupied = occupiedParts.has(table.parts[0]);
                    const partBOccupied = occupiedParts.has(table.parts[1]);
                    if (!partAOccupied && !partBOccupied) {
                        return { tableId: table.name, parts: [...table.parts], type: 'full' };
                    }
                }
            }
            return null;
        };

        // 檢查特定桌位是否被佔用 (用於還原訂單)
        const isTableOccupied = (date, timeStr, parts, existingBookings) => {
            const reqStart = timeToMinutes(timeStr);
            const reqEnd = reqStart + TOTAL_DURATION;

            const conflictBookings = existingBookings.filter(b => {
                if (b.date !== date || b.status === 'cancelled') return false;
                const bStart = timeToMinutes(b.time);
                const bEnd = bStart + TOTAL_DURATION;
                return reqStart < bEnd && reqEnd > bStart;
            });

            for (let b of conflictBookings) {
                if (Array.isArray(b.assignedParts)) {
                    for (let p of b.assignedParts) {
                        if (parts.includes(p)) return true; // 只要有一個部分被佔用，就視為衝突
                    }
                }
            }
            return false;
        };

        // 格式化桌號顯示 (處理內/外)
        const formatTableDisplay = (booking) => {
            if (!booking.assignedParts) return booking.tableId;
            
            // 如果是拆桌 (只佔用了一個部分)
            if (booking.assignedParts.length === 1) {
                const part = booking.assignedParts[0];
                if (part.endsWith('_In')) return booking.tableId + '內';
                if (part.endsWith('_Out')) return booking.tableId + '外';
            }
            return booking.tableId; 
        };

        // --- 主元件 ---
        const App = () => {
            const [view, setView] = useState('customer'); 
            const [bookings, setBookings] = useState([]);
            const [modalConfig, setModalConfig] = useState({ isOpen: false, title: '', content: '' });

            const showModal = (config) => setModalConfig({ ...config, isOpen: true });
            const closeModal = () => setModalConfig(prev => ({ ...prev, isOpen: false }));

            useEffect(() => {
                const saved = localStorage.getItem('hotpot_bookings');
                if (saved) setBookings(JSON.parse(saved));
            }, []);

            const saveBookings = (newBookings) => {
                setBookings(newBookings);
                localStorage.setItem('hotpot_bookings', JSON.stringify(newBookings));
            };

            const Header = () => (
                <div className="text-center py-6 px-4 animate-fade-in">
                    <h1 className="text-2xl md:text-3xl font-bold text-white mb-2 tracking-wide drop-shadow-md">{STORE_NAME}</h1>
                    <div className="text-gray-300 text-sm md:text-base space-y-2">
                        <p>本系統開放隔日至7日內、4人以下之訂位</p>
                        <p className="font-bold text-brand-gold">※ 用餐時間為 90 分鐘 ※</p>
                        <div className="flex items-center justify-center gap-2">
                            <span>如有其他需求敬請來電洽詢：</span>
                            <a href={`tel:${PHONE_NUMBER.replace(/-/g, '')}`} className="text-brand-gold font-bold hover:text-white flex items-center gap-1 bg-white/10 px-3 py-1 rounded-full transition border border-white/10 hover:bg-brand-gold hover:border-brand-gold">
                                <Icon name="Phone" size={14} /> {PHONE_NUMBER}
                            </a>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen pb-10 relative">
                    <Header />
                    <div className="max-w-md mx-auto relative z-10 px-4">
                        <div className="flex justify-center mb-6 text-sm font-medium text-gray-400 gap-6">
                            <button onClick={() => setView('customer')} className={`pb-1 transition ${view === 'customer' ? 'text-white border-b-2 border-brand-gold' : 'hover:text-gray-200'}`}>顧客訂位</button>
                            <button onClick={() => setView(view === 'admin' ? 'admin' : 'login')} className={`pb-1 transition ${view === 'admin' || view === 'login' ? 'text-white border-b-2 border-brand-gold' : 'hover:text-gray-200'}`}>店長專區</button>
                        </div>

                        {view === 'customer' && <CustomerView bookings={bookings} onBook={saveBookings} showModal={showModal} />}
                        {view === 'login' && <LoginView onSuccess={() => setView('admin')} />}
                        {view === 'admin' && <AdminView bookings={bookings} onUpdate={saveBookings} onLogout={() => setView('login')} showModal={showModal} closeModal={closeModal} />}
                    </div>
                    
                    <Modal {...modalConfig} onCancel={closeModal} />

                    <div className="fixed top-0 left-0 w-full h-full pointer-events-none -z-10 overflow-hidden bg-brand-blue">
                        <div className="absolute top-[-10%] right-[-10%] w-96 h-96 bg-blue-500 rounded-full blur-[100px] opacity-20"></div>
                        <div className="absolute bottom-[-10%] left-[-10%] w-72 h-72 bg-brand-gold rounded-full blur-[100px] opacity-10"></div>
                    </div>
                </div>
            );
        };

        const CustomerView = ({ bookings, onBook, showModal }) => {
            const dates = useMemo(() => getDates(false), []);
            const [step, setStep] = useState(1);
            const [selectedDate, setSelectedDate] = useState(dates[0].value);
            const [pax, setPax] = useState(2);
            const [sessionType, setSessionType] = useState('lunch');
            const [selectedTime, setSelectedTime] = useState(null);
            const [formData, setFormData] = useState({ name: '', gender: '先生', phone: '', note: '' });
            const [errors, setErrors] = useState({});
            const [finalBooking, setFinalBooking] = useState(null);

            useEffect(() => { setSelectedTime(null); }, [selectedDate, pax, sessionType]);
            const timeSlots = useMemo(() => generateTimeSlots(sessionType), [sessionType]);

            const validatePhone = (phone) => /^09\d{8}$/.test(phone.replace(/[-\s]/g, ''));

            const handleSubmit = (e) => {
                e.preventDefault();
                const newErrors = {};
                if (!formData.name.trim()) newErrors.name = "請輸入姓名";
                if (!validatePhone(formData.phone)) newErrors.phone = "手機格式錯誤 (需為09開頭共10碼)";
                if (Object.keys(newErrors).length > 0) { setErrors(newErrors); return; }

                const tableInfo = findAvailableTable(selectedDate, selectedTime, pax, bookings);
                if (!tableInfo) {
                    showModal({
                        title: "訂位失敗", content: "哎呀！該時段剛好被訂走了，請重新選擇時段。",
                        onConfirm: () => setStep(1), confirmText: "好的", type: 'info'
                    });
                    return;
                }

                const newBooking = {
                    id: Date.now().toString(),
                    date: selectedDate, time: selectedTime, pax: pax, type: sessionType,
                    ...formData,
                    tableId: tableInfo.tableId, assignedParts: tableInfo.parts,
                    status: 'confirmed', createdAt: new Date().toISOString()
                };

                onBook([...bookings, newBooking]);
                setFinalBooking(newBooking);
                setStep(3);
                window.scrollTo(0, 0);
            };

            if (step === 1) {
                return (
                    <div className="glass-panel rounded-2xl p-6 shadow-xl animate-fade-in">
                        <div className="space-y-6">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-gray-700 text-sm font-bold mb-2">用餐日期</label>
                                    <div className="relative">
                                        <select value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="w-full bg-brand-light border border-gray-200 rounded-lg py-2.5 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-brand-blue appearance-none">
                                            {dates.map(d => <option key={d.value} value={d.value}>{d.display}</option>)}
                                        </select>
                                        <div className="absolute right-3 top-3 pointer-events-none text-gray-500"><Icon name="Calendar" size={16} /></div>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-gray-700 text-sm font-bold mb-2">人數 (4人以下)</label>
                                    <div className="flex bg-brand-light rounded-lg border border-gray-200 overflow-hidden">
                                        {[1, 2, 3, 4].map(n => (
                                            <button key={n} onClick={() => setPax(n)} className={`flex-1 py-2 text-sm font-medium transition ${pax === n ? 'bg-brand-blue text-white' : 'text-gray-600 hover:bg-gray-200'}`}>{n}</button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div className="flex border-b-2 border-gray-200">
                                    <button onClick={() => setSessionType('lunch')} className={`flex-1 pb-2 text-center font-bold transition ${sessionType === 'lunch' ? 'text-brand-blue border-b-2 border-brand-blue -mb-[2px]' : 'text-gray-400 hover:text-gray-600'}`}>午餐時段</button>
                                    <button onClick={() => setSessionType('dinner')} className={`flex-1 pb-2 text-center font-bold transition ${sessionType === 'dinner' ? 'text-brand-blue border-b-2 border-brand-blue -mb-[2px]' : 'text-gray-400 hover:text-gray-600'}`}>晚餐時段</button>
                                </div>
                                <div className="mt-2 text-xs text-gray-500 text-center flex items-center justify-center gap-1"><Icon name="Clock" size={12} /> {sessionType === 'lunch' ? '營業時間至 15:00' : '營業時間至 22:00'}</div>
                            </div>
                            <div className="grid grid-cols-4 gap-2">
                                {timeSlots.map(time => {
                                    const available = findAvailableTable(selectedDate, time, pax, bookings);
                                    const isSelected = selectedTime === time;
                                    const isLate = (sessionType === 'lunch' && time >= "13:30") || (sessionType === 'dinner' && time >= "20:30");
                                    if (!available) return null;
                                    return (
                                        <button key={time} onClick={() => setSelectedTime(time)} className={`relative py-2.5 rounded-lg text-sm font-bold transition border ${isSelected ? 'bg-brand-gold text-white border-brand-gold shadow-md scale-105 z-10' : 'bg-white text-gray-700 border-gray-200 hover:border-brand-gold hover:text-brand-gold'}`}>
                                            {time}
                                            {isLate && isSelected && <span className="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-red-600 text-white text-[10px] py-1 px-2 rounded whitespace-nowrap shadow-md z-20">注意: 用餐時間不足90分鐘</span>}
                                        </button>
                                    );
                                })}
                            </div>
                            <button disabled={!selectedTime} onClick={() => setStep(2)} className={`w-full py-3.5 rounded-xl font-bold text-lg shadow-lg transition flex items-center justify-center gap-2 ${selectedTime ? 'bg-brand-blue text-white hover:bg-blue-900 transform active:scale-95' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}>下一步：填寫資料 <Icon name="ArrowRight" size={20} /></button>
                        </div>
                    </div>
                );
            }

            if (step === 2) {
                return (
                    <div className="glass-panel rounded-2xl p-6 shadow-xl animate-fade-in">
                        <button onClick={() => setStep(1)} className="text-gray-500 mb-4 flex items-center gap-1 hover:text-brand-blue transition text-sm"><Icon name="ArrowLeft" size={16} /> 返回選擇時段</button>
                        <h2 className="text-xl font-bold text-brand-blue mb-4 flex items-center gap-2"><Icon name="ClipboardList" size={20} /> 確認訂位資訊</h2>
                        <div className="bg-blue-50/80 p-4 rounded-lg mb-6 text-sm text-brand-blue border border-blue-100">
                            <div className="flex justify-between mb-2"><span className="text-gray-500">日期</span><span className="font-bold">{selectedDate}</span></div>
                            <div className="flex justify-between mb-2"><span className="text-gray-500">時間</span><span className="font-bold text-lg">{selectedTime}</span></div>
                            <div className="flex justify-between mb-2"><span className="text-gray-500">人數</span><span className="font-bold">{pax} 位</span></div>
                            <div className="flex justify-between"><span className="text-gray-500">用餐時限</span><span className="font-bold">90 分鐘</span></div>
                            {((sessionType === 'lunch' && selectedTime >= "13:30") || (sessionType === 'dinner' && selectedTime >= "20:30")) && <div className="mt-3 pt-3 border-t border-blue-200 text-red-600 text-xs flex items-start gap-1"><div className="mt-0.5"><Icon name="AlertCircle" size={14} /></div> 提醒您：營業時間 {sessionType === 'lunch' ? '15:00' : '22:00'} 結束，用餐時間只到營業時間結束（不足90分鐘）。</div>}
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-gray-700 text-sm font-bold mb-1">訂位大名</label>
                                <div className="flex gap-2">
                                    <div className="relative flex-1">
                                        <input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className={`w-full border rounded-lg py-2.5 pl-10 pr-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-brand-blue ${errors.name ? 'border-red-500' : 'border-gray-300'}`} placeholder="您的稱呼" />
                                        <div className="absolute left-3 top-3 text-gray-400"><Icon name="User" size={16} /></div>
                                    </div>
                                    <div className="flex bg-gray-100 rounded-lg p-1 border border-gray-200">
                                        <button type="button" onClick={() => setFormData({...formData, gender: '先生'})} className={`px-3 rounded-md text-sm font-medium transition ${formData.gender === '先生' ? 'bg-white text-brand-blue shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>先生</button>
                                        <button type="button" onClick={() => setFormData({...formData, gender: '小姐'})} className={`px-3 rounded-md text-sm font-medium transition ${formData.gender === '小姐' ? 'bg-white text-brand-blue shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>小姐</button>
                                    </div>
                                </div>
                                {errors.name && <p className="text-red-500 text-xs mt-1">{errors.name}</p>}
                            </div>
                            <div>
                                <label className="block text-gray-700 text-sm font-bold mb-1">手機號碼</label>
                                <div className="relative">
                                    <input type="tel" value={formData.phone} onChange={(e) => setFormData({...formData, phone: e.target.value})} className={`w-full border rounded-lg py-2.5 pl-10 pr-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-brand-blue ${errors.phone ? 'border-red-500' : 'border-gray-300'}`} placeholder="09xxxxxxxx" />
                                    <div className="absolute left-3 top-3 text-gray-400"><Icon name="Smartphone" size={16} /></div>
                                </div>
                                {errors.phone && <p className="text-red-500 text-xs mt-1">{errors.phone}</p>}
                            </div>
                            <div>
                                <label className="block text-gray-700 text-sm font-bold mb-1">備註 (選填)</label>
                                <textarea value={formData.note} onChange={(e) => setFormData({...formData, note: e.target.value})} className="w-full border border-gray-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-brand-blue h-20 resize-none" placeholder="例如：需要兒童椅、過敏食材等"></textarea>
                            </div>
                            <button type="submit" className="w-full bg-brand-blue text-white py-3.5 rounded-xl font-bold text-lg shadow-lg hover:bg-blue-900 transition mt-2 flex items-center justify-center gap-2"><Icon name="CheckCircle" size={20} /> 確認送出訂位</button>
                        </form>
                    </div>
                );
            }
            if (step === 3 && finalBooking) {
                return (
                    <div className="glass-panel rounded-2xl p-8 shadow-xl text-center animate-fade-in">
                        <div className="w-16 h-16 bg-brand-gold rounded-full flex items-center justify-center mx-auto mb-4 text-white shadow-lg animate-bounce"><Icon name="Check" size={32} /></div>
                        <h2 className="text-2xl font-bold text-brand-blue mb-2">訂位成功！</h2>
                        <p className="text-gray-600 mb-6 text-sm">感謝您的預約，我們期待您的光臨。</p>
                        <div className="bg-white border-2 border-brand-gold border-dashed rounded-lg p-6 mb-6 text-left relative overflow-hidden shadow-sm">
                            <div className="absolute top-0 right-0 bg-brand-gold text-white text-xs px-2 py-1 rounded-bl font-bold">已確認</div>
                            <div className="space-y-4">
                                <div className="flex items-start"><span className="text-gray-400 w-20 flex-shrink-0 text-sm flex items-center gap-1"><Icon name="User" size={12}/> 訂位人</span><span className="font-bold text-gray-800">{finalBooking.name} {finalBooking.gender}</span></div>
                                <div className="flex items-start"><span className="text-gray-400 w-20 flex-shrink-0 text-sm flex items-center gap-1"><Icon name="Phone" size={12}/> 電話</span><span className="font-bold text-gray-800 tracking-wide">{finalBooking.phone}</span></div>
                                <div className="flex items-start"><span className="text-gray-400 w-20 flex-shrink-0 text-sm flex items-center gap-1"><Icon name="Clock" size={12}/> 時間</span><span className="font-bold text-brand-gold text-lg">{finalBooking.date} {finalBooking.time}</span></div>
                                <div className="flex items-start"><span className="text-gray-400 w-20 flex-shrink-0 text-sm flex items-center gap-1"><Icon name="Users" size={12}/> 人數</span><span className="font-bold text-gray-800">{finalBooking.pax} 位</span></div>
                                {finalBooking.note && <div className="flex items-start bg-gray-50 p-2 rounded"><span className="text-gray-400 w-20 flex-shrink-0 text-sm flex items-center gap-1"><Icon name="MessageSquare" size={12}/> 備註</span><span className="text-gray-800 text-sm">{finalBooking.note}</span></div>}
                            </div>
                        </div>
                        <p className="text-xs text-gray-500 mb-6 leading-relaxed">若需取消或更改，請直接來電 <br/><a href={`tel:${PHONE_NUMBER.replace(/-/g, '')}`} className="underline text-brand-blue font-bold text-sm">{PHONE_NUMBER}</a></p>
                        <button onClick={() => { setStep(1); setFinalBooking(null); setFormData({ name: '', gender: '先生', phone: '', note: '' }); }} className="text-brand-blue font-bold hover:underline flex items-center justify-center gap-1 mx-auto"><Icon name="Home" size={16} /> 返回首頁</button>
                    </div>
                );
            }
        };

        const LoginView = ({ onSuccess }) => {
            const [pwd, setPwd] = useState('');
            const [error, setError] = useState('');
            const handleLogin = (e) => { e.preventDefault(); if (pwd === ADMIN_PASSWORD) onSuccess(); else setError("密碼錯誤，請重新輸入"); };
            return (
                <div className="glass-panel rounded-2xl p-8 shadow-xl max-w-sm mx-auto mt-10 animate-fade-in">
                    <h2 className="text-xl font-bold text-brand-blue mb-6 text-center flex items-center justify-center gap-2"><Icon name="Lock" size={20} /> 店長後台登入</h2>
                    <form onSubmit={handleLogin}>
                        <input type="password" className={`w-full border rounded-lg p-3 mb-2 text-center text-gray-900 focus:ring-2 focus:outline-none ${error ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 focus:ring-brand-blue'}`} placeholder="請輸入密碼" value={pwd} onChange={e => { setPwd(e.target.value); setError(''); }} />
                        {error && <p className="text-red-500 text-xs text-center mb-4">{error}</p>}
                        <button className="w-full bg-brand-blue text-white py-3 rounded-lg font-bold shadow-md hover:bg-blue-900 transition mt-2">登入</button>
                    </form>
                </div>
            );
        };

        // --- 手動訂位 Modal 內容 ---
        const ManualBookingForm = ({ onConfirm, onCancel, dates, generateTimeSlots, bookings }) => {
            const [date, setDate] = useState(dates[0].value);
            const [session, setSession] = useState('lunch');
            const [time, setTime] = useState('');
            const [pax, setPax] = useState(2);
            const [selectedTableValues, setSelectedTableValues] = useState([]); // Changed to array for multi-select
            const [name, setName] = useState('');
            const [phone, setPhone] = useState('');
            const [note, setNote] = useState('');
            const [error, setError] = useState('');

            const timeSlots = generateTimeSlots(session);
            
            // 取得所有可用桌位選項
            const tableOptions = useMemo(() => {
                if (!date || !time) return [];
                
                // 計算衝突
                const reqStart = timeToMinutes(time);
                const reqEnd = reqStart + TOTAL_DURATION;
                const conflictBookings = bookings.filter(b => {
                    if (b.date !== date || b.status === 'cancelled') return false;
                    const bStart = timeToMinutes(b.time);
                    const bEnd = bStart + TOTAL_DURATION;
                    return reqStart < bEnd && reqEnd > bStart;
                });
                
                const occupiedParts = new Set();
                conflictBookings.forEach(b => {
                    if (Array.isArray(b.assignedParts)) {
                        b.assignedParts.forEach(p => occupiedParts.add(p));
                    }
                });

                const options = [];
                TABLES.forEach(t => {
                    // 整桌選項
                    const isFullOccupied = occupiedParts.has(t.parts[0]) || occupiedParts.has(t.parts[1]);
                    options.push({
                        label: `${t.name} (整桌)`,
                        value: JSON.stringify({ tableId: t.name, parts: t.parts }),
                        disabled: isFullOccupied
                    });
                    
                    // 分桌選項 - A (內)
                    const isAOccupied = occupiedParts.has(t.parts[0]);
                    options.push({
                        label: `${t.name} (內)`,
                        value: JSON.stringify({ tableId: t.name, parts: [t.parts[0]] }),
                        disabled: isAOccupied
                    });
                    
                    // 分桌選項 - B (外)
                    const isBOccupied = occupiedParts.has(t.parts[1]);
                    options.push({
                        label: `${t.name} (外)`,
                        value: JSON.stringify({ tableId: t.name, parts: [t.parts[1]] }),
                        disabled: isBOccupied
                    });
                });
                
                return options;
            }, [date, time, bookings]);

            // 重置 table 選擇當時間改變
            useEffect(() => {
                setSelectedTableValues([]);
            }, [date, time]);

            // 根據選中的部分建構顯示名稱
            const constructDisplayTableId = (allPartsSet) => {
                const labels = [];
                TABLES.forEach(table => {
                    const hasA = allPartsSet.has(table.parts[0]);
                    const hasB = allPartsSet.has(table.parts[1]);
                    
                    if (hasA && hasB) {
                        labels.push(table.name);
                    } else if (hasA) {
                        labels.push(table.name + "內");
                    } else if (hasB) {
                        labels.push(table.name + "外");
                    }
                });
                return labels.join("、");
            };

            const getBookingData = (isBlock = false) => {
                if (!time) { setError('請選擇時間'); return null; }
                if (selectedTableValues.length === 0) { setError('請選擇至少一個桌號'); return null; }
                if (!isBlock && !name.trim()) { setError('請輸入姓名或註記'); return null; }
                
                const allParts = new Set();
                let combinedTableId = "";

                selectedTableValues.forEach(val => {
                    const obj = JSON.parse(val);
                    obj.parts.forEach(p => allParts.add(p));
                });
                
                combinedTableId = constructDisplayTableId(allParts);

                return {
                    id: Date.now().toString(),
                    date, time, pax, type: session,
                    name: isBlock ? '已鎖定 (現場保留)' : name, 
                    phone: isBlock ? '-' : (phone || '-'), 
                    note: isBlock ? '後台鎖桌' : note, 
                    gender: '',
                    tableId: combinedTableId, 
                    assignedParts: Array.from(allParts),
                    status: 'confirmed', 
                    createdAt: new Date().toISOString()
                };
            };

            const handleSubmit = () => {
                const booking = getBookingData(false);
                if (booking) onConfirm(booking);
            };

            const handleQuickBlock = () => {
                const booking = getBookingData(true);
                if (booking) onConfirm(booking);
            };

            return (
                <div className="space-y-4">
                    <div className="grid grid-cols-2 gap-3">
                        <div>
                            <label className="text-xs font-bold text-gray-500 block mb-1">日期</label>
                            <select value={date} onChange={e => setDate(e.target.value)} className="w-full border rounded p-2 text-sm text-gray-900">
                                {dates.map(d => <option key={d.value} value={d.value}>{d.display}</option>)}
                            </select>
                        </div>
                        <div>
                             <label className="text-xs font-bold text-gray-500 block mb-1">時段</label>
                             <div className="flex border rounded overflow-hidden">
                                <button onClick={() => setSession('lunch')} className={`flex-1 py-2 text-xs font-bold ${session === 'lunch' ? 'bg-brand-blue text-white' : 'bg-gray-100 text-gray-600'}`}>午</button>
                                <button onClick={() => setSession('dinner')} className={`flex-1 py-2 text-xs font-bold ${session === 'dinner' ? 'bg-brand-blue text-white' : 'bg-gray-100 text-gray-600'}`}>晚</button>
                             </div>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                        <div>
                            <label className="text-xs font-bold text-gray-500 block mb-1">時間</label>
                            <select value={time} onChange={e => {setTime(e.target.value); setError('');}} className="w-full border rounded p-2 text-sm text-gray-900">
                                <option value="">請選擇</option>
                                {timeSlots.map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="text-xs font-bold text-gray-500 block mb-1">人數</label>
                            <select value={pax} onChange={e => setPax(Number(e.target.value))} className="w-full border rounded p-2 text-sm text-gray-900">
                                {Array.from({length: 20}, (_, i) => i + 1).map(n => (
                                    <option key={n} value={n}>{n} 人</option>
                                ))}
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label className="text-xs font-bold text-gray-500 block mb-1">指定桌號 (可複選)</label>
                        <div className={`border rounded p-2 h-32 overflow-y-auto bg-white ${!time ? 'bg-gray-50' : ''}`}>
                            {time ? tableOptions.map((opt, idx) => (
                                <label key={idx} className={`flex items-center space-x-2 p-1.5 rounded hover:bg-gray-50 mb-1 ${opt.disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}>
                                    <input 
                                        type="checkbox" 
                                        value={opt.value}
                                        checked={selectedTableValues.includes(opt.value)}
                                        onChange={() => {
                                            if (opt.disabled) return;
                                            if (selectedTableValues.includes(opt.value)) {
                                                setSelectedTableValues(prev => prev.filter(v => v !== opt.value));
                                            } else {
                                                setSelectedTableValues(prev => [...prev, opt.value]);
                                            }
                                            setError('');
                                        }}
                                        disabled={opt.disabled}
                                        className="rounded text-brand-blue focus:ring-brand-blue w-4 h-4"
                                    />
                                    <span className="text-sm text-gray-900 font-medium">
                                        {opt.label} {opt.disabled ? <span className="text-red-400 text-xs ml-1">(已佔用)</span> : ''}
                                    </span>
                                </label>
                            )) : <div className="text-gray-400 text-sm text-center py-4">請先選擇時間以查看空桌</div>}
                        </div>
                    </div>

                    {error && <div className="text-red-500 text-xs font-bold bg-red-50 p-2 rounded">{error}</div>}

                    <div className="border-t pt-3">
                         <label className="text-xs font-bold text-gray-500 block mb-1">客人姓名 / 備註</label>
                         <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="輸入姓名或保留原因" className="w-full border rounded p-2 text-sm text-gray-900 mb-2"/>
                         
                         <label className="text-xs font-bold text-gray-500 block mb-1">電話 (選填)</label>
                         <input type="text" value={phone} onChange={e => setPhone(e.target.value)} placeholder="輸入電話" className="w-full border rounded p-2 text-sm text-gray-900 mb-2"/>
                    </div>

                    <div className="flex gap-2 pt-2">
                        <button onClick={handleQuickBlock} className="flex-1 bg-gray-600 text-white py-2 rounded text-sm font-bold hover:bg-gray-700">快速鎖桌 (現場保留)</button>
                        <button onClick={handleSubmit} className="flex-1 bg-brand-gold text-white py-2 rounded text-sm font-bold hover:bg-yellow-600">確認新增訂位</button>
                    </div>
                </div>
            );
        };

        const AdminView = ({ bookings, onUpdate, onLogout, showModal, closeModal }) => {
            const todayStr = new Date().toISOString().split('T')[0];
            
            // 篩選日期：只保留 >= 今天的日期
            const availableDates = useMemo(() => {
                const dates = getDates(true); // 取得包含今天及未來的日期
                const existingDates = bookings.map(b => b.date).filter(d => d >= todayStr);
                const allDates = Array.from(new Set([...dates.map(d => d.value), ...existingDates])).sort();
                return allDates;
            }, [bookings, todayStr]);

            const [filterDate, setFilterDate] = useState(() => {
                if (bookings.length > 0) {
                     // 優先顯示最近一筆「未來」或「今天」的訂單日期
                     const validBookings = bookings.filter(b => b.date >= todayStr);
                     if (validBookings.length > 0) return validBookings[validBookings.length - 1].date;
                }
                return todayStr;
            });

            // 確保 filterDate 不會選到過去的日期 (除非是手動選的)
            useEffect(() => {
                if (filterDate < todayStr && availableDates.includes(todayStr)) {
                    setFilterDate(todayStr);
                }
            }, [todayStr]);

            const filteredBookings = bookings
                .filter(b => b.date === filterDate) // Remove status filter to show cancelled
                .sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time));

            const toggleArrived = (id) => {
                const newBookings = bookings.map(b => 
                    b.id === id ? { ...b, arrived: !b.arrived } : b
                );
                onUpdate(newBookings);
            };

            const cancelBooking = (id) => {
                showModal({
                    title: "取消確認",
                    content: "您確定要取消此筆訂位嗎？取消後桌號將被釋放。",
                    onConfirm: () => {
                        const newBookings = bookings.map(b => 
                            b.id === id ? { ...b, status: 'cancelled' } : b
                        );
                        onUpdate(newBookings);
                        closeModal();
                    },
                    confirmText: "確認取消",
                    cancelText: "保留",
                    type: 'danger'
                });
            };

            const restoreBooking = (id) => {
                const bookingToRestore = bookings.find(b => b.id === id);
                if (!bookingToRestore) return;

                // Check availability
                if (isTableOccupied(bookingToRestore.date, bookingToRestore.time, bookingToRestore.assignedParts || [], bookings)) {
                    showModal({
                        title: "還原失敗",
                        content: "該時段的桌位已被佔用，無法還原此訂位。",
                        onConfirm: () => closeModal(),
                        confirmText: "了解",
                        type: 'info'
                    });
                    return;
                }

                showModal({
                    title: "還原確認",
                    content: "確認要還原此筆訂位嗎？",
                    onConfirm: () => {
                        const newBookings = bookings.map(b => 
                            b.id === id ? { ...b, status: 'confirmed' } : b
                        );
                        onUpdate(newBookings);
                        closeModal();
                    },
                    confirmText: "確認還原",
                    cancelText: "取消",
                    type: 'danger' // Use danger style for emphasis, or standard blue
                });
            };
            
            // 開啟手動訂位 Modal
            const openManualBooking = () => {
                showModal({
                    title: "後台手動新增 / 鎖桌",
                    customContent: (
                        <ManualBookingForm 
                            dates={getDates(true)}
                            generateTimeSlots={generateTimeSlots}
                            bookings={bookings}
                            onCancel={closeModal}
                            onConfirm={(newBooking) => {
                                onUpdate([...bookings, newBooking]);
                                closeModal();
                                setFilterDate(newBooking.date); // 跳轉到該日期
                            }}
                        />
                    )
                });
            };

            return (
                <div className="glass-panel rounded-2xl p-4 shadow-xl min-h-[500px] animate-fade-in flex flex-col">
                    <div className="flex justify-between items-center mb-4 border-b pb-3">
                        <h2 className="text-lg font-bold text-brand-blue flex items-center gap-2"><Icon name="Settings" size={18} /> 訂位管理</h2>
                        <div className="flex gap-3 items-center">
                            <button onClick={openManualBooking} className="text-xs bg-brand-gold text-white px-2 py-1 rounded font-bold hover:bg-yellow-600 transition flex items-center gap-1">
                                <Icon name="Plus" size={12} /> 手動新增 / 鎖桌
                            </button>
                            <button onClick={onLogout} className="text-sm text-gray-500 hover:text-red-500 flex items-center gap-1"><Icon name="LogOut" size={14} /> 登出</button>
                        </div>
                    </div>

                    <div className="mb-4 bg-gray-50 p-3 rounded-lg">
                        <label className="text-xs text-gray-500 font-bold uppercase block mb-1 flex items-center gap-1"><Icon name="Calendar" size={12} /> 選擇日期</label>
                        <select value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className="w-full bg-white border border-gray-300 rounded p-2 text-sm text-gray-900 focus:outline-none focus:ring-1 focus:ring-brand-blue">
                            {availableDates.map(d => (
                                <option key={d} value={d}>{d}</option>
                            ))}
                        </select>
                    </div>

                    <div className="space-y-3 overflow-y-auto flex-1 pr-1 custom-scrollbar">
                        {filteredBookings.length === 0 ? (
                            <div className="text-center text-gray-400 py-10 flex flex-col items-center">
                                <Icon name="Coffee" size={48} className="mb-2 opacity-50" />
                                <p>該日期尚無訂位</p>
                            </div>
                        ) : (
                            filteredBookings.map(b => {
                                const isCancelled = b.status === 'cancelled';
                                return (
                                <div key={b.id} className={`bg-white border-l-4 rounded shadow-sm p-3 relative transition-all ${isCancelled ? 'border-gray-400 bg-gray-100 opacity-60' : b.arrived ? 'border-green-500 bg-green-50' : 'border-brand-blue'}`}>
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className={`text-xl font-bold font-mono ${isCancelled ? 'text-gray-500 line-through' : 'text-brand-blue'}`}>{b.time}</span>
                                                <span className={`text-xs px-1.5 py-0.5 rounded font-medium ${isCancelled ? 'bg-gray-200 text-gray-600' : b.type === 'lunch' ? 'bg-orange-100 text-orange-700' : 'bg-indigo-100 text-indigo-700'}`}>{b.type === 'lunch' ? '午' : '晚'}</span>
                                                <span className={`text-sm font-bold border px-1.5 rounded ${isCancelled ? 'text-gray-500 border-gray-400 bg-gray-200' : 'text-brand-gold border-brand-gold bg-yellow-50'}`}>{formatTableDisplay(b)}</span>
                                                {isCancelled && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded font-bold">已取消</span>}
                                            </div>
                                            <div className={`font-bold flex items-center gap-2 ${isCancelled ? 'text-gray-500' : 'text-gray-800'}`}>
                                                {b.name} {b.gender}
                                                <span className="text-xs font-normal text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded-full">{b.pax}人</span>
                                            </div>
                                            <a href={isCancelled ? undefined : `tel:${b.phone}`} className={`text-sm flex items-center gap-1 mt-1 ${isCancelled ? 'text-gray-400 cursor-default' : 'text-gray-500 hover:text-blue-600'}`}><Icon name="Phone" size={12} /> {b.phone}</a>
                                            {b.note && <div className="text-xs text-gray-600 bg-gray-100 p-1.5 mt-2 rounded border border-gray-200 flex items-start gap-1"><span className="mt-0.5"><Icon name="MessageSquare" size={10} /></span> {b.note}</div>}
                                        </div>
                                        <div className="flex flex-col gap-2 ml-3">
                                            {!isCancelled ? (
                                                <>
                                                    <button onClick={() => toggleArrived(b.id)} className={`px-3 py-1.5 text-xs rounded-md font-bold transition flex items-center justify-center gap-1 w-20 ${b.arrived ? 'bg-green-500 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-green-500 hover:text-white'}`}>{b.arrived ? <><Icon name="Check" size={12}/> 已到</> : '確認報到'}</button>
                                                    <button onClick={() => cancelBooking(b.id)} className="px-3 py-1.5 text-xs rounded-md font-bold bg-red-50 text-red-400 hover:bg-red-500 hover:text-white transition w-20">取消</button>
                                                </>
                                            ) : (
                                                <button onClick={() => restoreBooking(b.id)} className="px-3 py-1.5 text-xs rounded-md font-bold bg-blue-50 text-blue-500 hover:bg-blue-600 hover:text-white transition w-20 flex items-center justify-center gap-1"><Icon name="RotateCcw" size={12}/> 還原</button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
